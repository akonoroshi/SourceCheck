snapshot {
    @defBlock SAY {
        doSayFor(@anything)
    }
    @defBlock ASK {
        doAsk(@anything)
    }
    @+defVar (VAR, GLOBAL, LOCAL) {
        stage {
            sprite {
                script {
                    @+optional {
                        @+or {
                            receiveGo
                            receiveMessage(literal)
                        }
                    }
                    @if (VAR, LOCAL) { doDeclareVariables(list(literal)) }
                    @+defVar (SET_VAR, FIRST, LAST) {
                        @if (SET_VAR, FIRST) { doSetVar(literal, reportRandom(literal, literal)) }
                        @+repeat(1, 2) {
                            @block SAY
                        }
                        @block ASK
                        doSayFor(reportJoinWords(list(literal, getLastAnswer)), literal)
                        @if (SET_VAR, LAST) { doSetVar(literal, reportRandom(literal, literal)) }
                    }
                    @defVar (GUESS_VAR) {
                        @defBlock GUESS {
                            @if (GUESS_VAR) { var }
                            @unless (GUESS_VAR) { getLastAnswer }
                        }
                        @defBlock GET_GUESS {
                            @block ASK
                            @if (GUESS_VAR) { doSetVar(literal, getLastAnswer) }
                        }
                        @defBlock EQ_COMPARE {
                            reportEquals(@block GUESS, var)
                        }
                        @defBlock NOT_EQ_COMPARE {
                            reportLessThan(@or {
                                @inline { @block GUESS, var }
                                @inline { var, @block GUESS }
                            })
                        }

                        @defVar (ASK_TOP) {
                            @defVar (CORRECT_IN_LOOP) {
                                @defBlock EQ_FEEDBACK {
                                    @if (CORRECT_IN_LOOP) {
                                        doIf(@block EQ_COMPARE, script {
                                            @block SAY
                                        })
                                    }
                                }
                                @defBlock NOT_EQ_FEEDBACK_IFS {
                                    @anyOrder {
                                        doIf(reportLessThan(@block GUESS, var), script {
                                            @block SAY
                                            @if (ASK_TOP) { @block ASK }
                                        })
                                        doIf(reportLessThan(var, @block GUESS), script {
                                            @block SAY
                                            @if (ASK_TOP) { @block ASK }
                                        })
                                    }
                                }
                                @defBlock NOT_EQ_FEEDBACK_IF_ELSE {
                                    doIfElse(@block NOT_EQ_COMPARE, script {
                                        @block SAY
                                    }, script {
                                        @block SAY
                                    })
                                    @if (ASK_TOP) { @block ASK }
                                }
                                @defBlock NOT_EQ_FEEDBACK {
                                    @or {
                                        @block NOT_EQ_FEEDBACK_IFS
                                        @block NOT_EQ_FEEDBACK_IF_ELSE
                                    }
                                }

                                @if (ASK_TOP) { @block ASK }
                                doUntil(@block EQ_COMPARE, script {
                                    @unless (ASK_TOP) { @block ASK }
                                    @or {
                                        @inline {
                                            @block EQ_FEEDBACK
                                            @if (ASK_TOP) { @block NOT_EQ_FEEDBACK }
                                            @unless (ASK_TOP) { @block NOT_EQ_FEEDBACK_IFS }
                                        }
                                        doIfElse(@block EQ_COMPARE, script {
                                            @if (CORRECT_IN_LOOP) { doSayFor(literal) }
                                        }, script {
                                            @block NOT_EQ_FEEDBACK
                                        })
                                    }
                                })
                                @unless (CORRECT_IN_LOOP) { doSayFor(literal) }
                            }
                        }

                    }
                }
            }
        }
        @if (VAR, GLOBAL) { var }
    }
}